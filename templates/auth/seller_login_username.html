<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>Login - JWT Authentication</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script
      src="https://use.fontawesome.com/releases/v6.3.0/js/all.js"
      crossorigin="anonymous"
    ></script>
    <style>
      .error-message {
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 0.25rem;
      }
    </style>
  </head>
  <body class="bg-primary">
    <div id="layoutAuthentication">
      <div id="layoutAuthentication_content">
        <main>
          <div class="container">
            <div class="row justify-content-center">
              <div class="col-lg-5">
                <div class="card shadow-lg border-0 rounded-lg mt-5">
                  <div class="card-header">
                    <h3 class="text-center font-weight-light my-4">Login</h3>
                  </div>
                  <div class="card-body">
                    <form id="loginForm" onsubmit="handleLogin(event)">
                      <div class="form-floating mb-3">
                        <input
                          class="form-control"
                          id="inputUsername"
                          name="username"
                          type="text"
                          required
                        />
                        <label for="inputUsername">Username</label>
                      </div>
                      <div class="form-floating mb-3">
                        <input
                          class="form-control"
                          id="inputPassword"
                          name="password"
                          type="password"
                          required
                        />
                        <label for="inputPassword">Password</label>
                      </div>
                      <div class="form-check mb-3">
                        <input
                          class="form-check-input"
                          id="inputRememberPassword"
                          type="checkbox"
                        />
                        <label
                          class="form-check-label"
                          for="inputRememberPassword"
                          >Remember Me</label
                        >
                      </div>
                      <div
                        id="errorMessage"
                        class="error-message d-none mb-3"
                      ></div>
                      <div
                        class="d-flex align-items-center justify-content-between mt-4 mb-0"
                      >
                        <a class="small" href="/forgot-password"
                          >Forgot Password?</a
                        >
                        <button type="submit" class="btn btn-primary">
                          Login
                        </button>
                      </div>
                    </form>
                  </div>
                  <div class="card-footer text-center py-3">
                    <div class="small">
                      <a href="/register">Need an account? Sign up!</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script>
      // Add getCookie function
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === name + "=") {
              cookieValue = decodeURIComponent(
                cookie.substring(name.length + 1)
              );
              break;
            }
          }
        }
        return cookieValue;
      }

      // Also add setAuthHeader function that was referenced but not defined
      function setAuthHeader(token) {
        if (token) {
          // Set for future fetch requests
          window.localStorage.setItem("Authorization", `Bearer ${token}`);
        } else {
          window.localStorage.removeItem("Authorization");
        }
      }

      function parseJwt(token) {
        try {
          const base64Url = token.split(".")[1];
          const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
          return JSON.parse(window.atob(base64));
        } catch (error) {
          console.error("Error parsing JWT:", error);
          return null;
        }
      }

      // Modify your handleLogin function
      async function handleLogin(event) {
        event.preventDefault();
        const errorMessage = document.getElementById("errorMessage");
        errorMessage.classList.add("d-none");

        const formData = new FormData(event.target);
        const credentials = {
          username: formData.get("username"),
          password: formData.get("password"),
        };

        try {
          const response = await fetch("http://127.0.0.1:8000/en/api/token/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCookie("csrftoken"),
            },
            body: JSON.stringify(credentials),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.detail || "Invalid credentials");
          }

          // Store tokens securely
          localStorage.setItem("accessToken", data.access);
          localStorage.setItem("refreshToken", data.refresh);

          // Set default Authorization header for future requests
          setAuthHeader(data.access);

          //window.location.href = '../dashboards/seller_dashboard.html'; // Seller dashboard
          // Redirect to the seller dashboard with tokens as query parameters
          window.location.href = "{% url 'seller_dashboard'%}";

          // Handle "Remember Me" functionality
          if (document.getElementById("inputRememberPassword").checked) {
            const secure = window.location.protocol === "https:";
            document.cookie = `refreshToken=${
              data.refresh
            }; max-age=604800; path=/; ${
              secure ? "secure;" : ""
            } samesite=strict`;
          }
        } catch (error) {
          errorMessage.textContent =
            error.message || "Login failed. Please try again.";
          errorMessage.classList.remove("d-none");
        }
      }
    </script>
  </body>
</html>
